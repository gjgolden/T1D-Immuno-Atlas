---
title: "HPAP_Flow-Cytometry_Immune-Lineage_Minimal-Code"
author: "Gregory_Golden"
date: "2023-11-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Section 1: Install Requisite Packages
```{r Section 1: Packages}
library(dplyr)
library(stringr)
library(tidyr)
library(forcats)
library(ggplot2)
library(rstatix) #dplyr-compatible stats package
library(ComplexHeatmap) #heatmap generation
library(circlize) #part of ComplexHeatmap requirements
library(ggrepel) #label annotations
library(cluster) #required for heatmap generation
library(GGally) #making pairwise plots
library(broom) #prints stats test outcomes as data frames
library(ggpubr) #adds p-values annotations to ggplots
library(gt) #exporting nice looking tables
library(webshot2) #exporting nice looking tables
library(WRS2) #contains robust statistical tests
library(multcomp) #allows for multiple comparisons within ANCOVA
library(ggridges) #for ggplot compatible ridge plots
```


Section 2: Functions
```{r Section 2: Functions}

tissueColisANOVA <- function(anovapops, tissues, df, selectpops) {
  pvalPop <- c()
  pvalTissue <- c()
  pvalTest <- c()
  pvalAAbT1D <- c()
  pvalNDT1D <- c()
  pvalNDAAb <- c()
  
  for (x in anovapops) {
    for (t in tissues) {
      dfAnova <- df %>%
          filter(Tissue == t) %>%
          filter(metric == x) %>%
          mutate(`Disease_Status` = as_factor(`Disease_Status`))
      if (x %in% coldIsPops2) {
        pval.aov <- glht(aov(value ~ cold_ischemia + `Disease_Status`, data = dfAnova), 
                         linfct = mcp(`Disease_Status` = "Tukey"))
        tablepval <- summary(pval.aov)
        tablepval <- tablepval[[10]]$pvalues
        pvalAAbT1D <- append(pvalAAbT1D, tablepval[1])
        pvalNDT1D <- append(pvalNDT1D, tablepval[2])
        pvalNDAAb <- append(pvalNDAAb, tablepval[3])
        pvalTest <- append(pvalTest, "ancova")
      } else {
        pval.aov <- lincon(value ~ `Disease_Status`, data = dfAnova, tr = 0.1)
        tablepval <- pval.aov[1]$comp
        tablepval <- tablepval[,6]
        pvalNDAAb <- append(pvalNDAAb, tablepval[3])
        pvalAAbT1D <- append(pvalAAbT1D, tablepval[1])
        pvalNDT1D <- append(pvalNDT1D, tablepval[2])
        pvalTest <- append(pvalTest, "robust anova")
      }
      pvalPop <- append(pvalPop, x)
      pvalTissue <- append(pvalTissue, t)
      }
  }
  dfstats <- data.frame(immune_pop = pvalPop,
                        tissue = pvalTissue,
                        ND_T1D = pvalNDT1D,
                        ND_AAb = pvalNDAAb,
                        AAb_T1D = pvalAAbT1D,
                        test = pvalTest)
  return(dfstats)
}
lntypeColisANOVA <- function(anovapops, lntype, df, selectpops) {
  pvalPop <- c()
  pvalLNtype <- c()
  pvalTest <- c()
  pvalAAbT1D <- c()
  pvalNDT1D <- c()
  pvalNDAAb <- c()
  
  for (x in anovapops) {
    for (t in lntype) {
      dfAnova <- df %>%
          filter(LN_type == t) %>%
          filter(metric == x) %>%
          mutate(Disease_Status = as_factor(Disease_Status))
      if (x %in% coldIsPops2) {
        pval.aov <- glht(aov(value ~ cold_ischemia + Disease_Status, data = dfAnova), 
                         linfct = mcp(`Disease_Status` = "Tukey"))
        tablepval <- summary(pval.aov)
        tablepval <- tablepval[[10]]$pvalues
        pvalAAbT1D <- append(pvalAAbT1D, tablepval[1])
        pvalNDT1D <- append(pvalNDT1D, tablepval[2])
        pvalNDAAb <- append(pvalNDAAb, tablepval[3])
        pvalTest <- append(pvalTest, "ancova")
      } else {
        pval.aov <- lincon(value ~ Disease_Status, data = dfAnova, tr = 0.1)
        tablepval <- pval.aov[1]$comp
        tablepval <- tablepval[,6]
        pvalNDAAb <- append(pvalNDAAb, tablepval[3])
        pvalAAbT1D <- append(pvalAAbT1D, tablepval[1])
        pvalNDT1D <- append(pvalNDT1D, tablepval[2])
        pvalTest <- append(pvalTest, "robust anova")
      }
      pvalPop <- append(pvalPop, x)
      pvalLNtype <- append(pvalLNtype, t)
      }
  }
  dfstats <- data.frame(immune_pop = pvalPop,
                        tissue = pvalLNtype,
                        ND_T1D = pvalNDT1D,
                        ND_AAb = pvalNDAAb,
                        AAb_T1D = pvalAAbT1D,
                        test = pvalTest)
  return(dfstats)
}
```


Section 3: Data from the HPAP Lineage Flow Cytometry Panel (CSV file of percentages) is imported and readied for further analysis
```{r Section 3: Data Import}
df <- read.csv("./data/Lineage_MasterV3.csv", 
               check.names = FALSE,
               stringsAsFactors = FALSE)

df <- dplyr::select(df, 1:`CD4 Tnaive1- CD127+`)

df <- df %>%
  mutate(across(.cols = "CD45+":ncol(df), .fns = ~ str_replace_all(., "%$", ""))) %>%
  mutate(across(.cols = "CD45+":ncol(df), .fns = ~ as.numeric(.))) %>%
  mutate(across(.cols = "CD45+":ncol(df), .fns = ~ case_when(. < 0.01 ~ 0.005, TRUE ~ as.numeric(.)))) %>%
  mutate("Age" = as.numeric(df$Age)) %>%
  mutate("Aabs" = as.numeric(df$Aabs)) %>%
  mutate(LN_type = case_when(str_detect(Tissue, "_pLN$") ~ "pLN",
                             str_detect(Tissue, "_mLN$") ~ "mLN",
                             Tissue == "Spleen" ~ "Spleen",
                             Tissue == "PBMC" ~ "PBMC",
                             Tissue == "Whole_Blood" ~ "Whole_Blood",
                             Tissue == "Tonsil" ~ "Tonsil",
                             Tissue == "Thymus" ~ "Thymus",
                             Tissue == "Islet_Sup" ~ "Islet")) %>%
  relocate(LN_type, .after = Tissue)

#import and prepare patient metadata
dfMeta <- read.csv("./metadata/Donor_Metadata.csv",
                   check.names = FALSE,
                   stringsAsFactors = FALSE)

dfMeta <- dfMeta %>%
  filter(str_detect(donor, "HPAP"))

dfLong <- df %>%
  pivot_longer(cols = c(`CD45+`:ncol(.)), names_to = "metric", values_to = "value")

dfFresh <- filter(dfLong, `Fresh/Thawed` == "fresh")

#a more specific naive T cell gating strategy was needed, so the Tnaive population (CD45RA+CCR7+) was separated into two populations based upon CD27 and CD127 expression: Tnaive1 (CD27+CD127+ naive T cells, bona fide naive) and Tnaive 1- (all other CD45RA+CCR7+ T cells). 
#The Tnaive population will be filtered out, since it encompasses all CD45RA+CCR7+ T cells and is redundant/less specific.
#Tnaive1 will be re-named "Tn" and Tnaive1- will be renamed "Tnl"
dfFresh <- dfFresh %>%
  filter(!str_detect(metric, "Tnaive ")) %>%
  filter(!str_detect(metric, "Tnaive$")) %>%
  mutate(metric = str_replace_all(.$metric, "Tnaive1-", "Tnl")) %>%
  mutate(metric = str_replace_all(.$metric, "Tnaive1", "Tn"))

#Thymus and mixed pLN are not standard HPAP tissues, and therefore will be filtered out
dfFresh <- filter(dfFresh, Tissue != "Thymus", Tissue != "pLN_mix_pLN")

#Add additional patient metadata
dfMetaSubset <- dfMeta %>%
  dplyr::select(c("donor", "cold_ischemia")) %>% #cold ischemia to be explored as variable that impacts immune pop frequency
  rename("HPAP Donor" = "donor")

dfFresh <- dfFresh %>%
  left_join(dfMetaSubset, by = "HPAP Donor") %>%
  relocate(cold_ischemia, .after = `Fresh/Thawed`)
```


Section 4: Compare immune population frequencies between different scientists
```{r Section 4: Scientist Comparisons}
#as HPAP is a study occurring over several years, different researchers have led the project
#therefore, the effect of researcher on immune population frequency was checked

dfScientistStat <- dfFresh %>%
  filter(Staining_Flow_Researcher == "D" | Staining_Flow_Researcher == "A") %>% #these researchers did the vast majority of the data acquisition, and are the only ones considered for this comparison
  filter(LN_type == "pLN") %>%
  filter(`Disease Status` == "ND") %>%
  filter(!str_detect(metric, "Tn CD127.CD27.")) %>% #all filtered values are 0, stats test would fail
  filter(!str_detect(metric, "Tn CD127.")) %>% #all filtered values are 100, stats test would fail
  filter(!str_detect(metric, "Tn CD27.")) %>% #all filtered values are 100, stats test would fail
  group_by(metric) %>%
  wilcox_test(value ~ Staining_Flow_Researcher) %>%
  adjust_pvalue() %>%
  filter(p.adj < 0.05) %>%
  mutate(pvalSymbol = case_when(p.adj < 0.001 ~ "***",
                          p.adj >= 0.001 & p.adj < 0.01 ~ "**",
                          p.adj >= 0.01 & p.adj < 0.05 ~ "*")) %>%
  arrange(p.adj)

ScientistComp <- dfFresh %>%
  filter(Staining_Flow_Researcher != "C") %>%
  filter(metric %in% dfScientistStat$metric) %>%
  filter(`Disease Status` == "ND") %>%
  mutate(metric = fct_relevel(`metric`, dfScientistStat$metric)) %>%
  ggplot(aes(Staining_Flow_Researcher, value, color = Staining_Flow_Researcher)) +
  geom_boxplot(outlier.size = 0.3) +
  stat_pvalue_manual(data = dfScientistStat, label = "pvalSymbol", 
                     y.position = 105, xmin = "group1", xmax = "group2",
                     tip.length = 0, label.size = 2) +
  ylab("% of Parent") +
  guides(color = guide_legend(title = "Researcher")) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.length = unit(0, "in"),
  ) +
  facet_wrap(~factor(metric), nrow = 1, strip.position = "bottom") +
  theme(strip.text.x.bottom = element_text(angle = 90, hjust = 1, size = 6),
        strip.background = element_blank(),
        strip.placement = "outside")
saveRDS(ScientistComp, file = "./outs/rds/ScientistComparison.RDS")

#Results show that there are several parameters that differ between researchers, mainly in PD1, HLA-DR, and CD25 on certain CD4+ T cells. This could be due to differential flow cytometry parameter settings on the cytometer (antibody titrations or conjugations did not change between researchers). 
#Populations that were significantly different between researchers were filtered (see below), keeping the researcher's results (Researcher D) who analyzed the data and compiled it for the manuscript.

ScientistFilter <- c("CD4 Mem PD1+", "CD4 Tcm PD1+", "CD4 Tem PD1+", "CD4 Temra PD1+", "CD4 Tn PD1+", "CD4 Tnl PD1+", "CD4 Tem HLA-DR+", "CD4 Temra HLA-DR+", "CD4 Tcm HLA-DR+", "CD8 Temra HLA-DR+", "CD4 Tem HLA-DR+ CD38+", "CD4 Temra HLA-DR+ CD38+", "CD4 Tcm HLA-DR+ CD38+", "CD8 Temra HLA-DR+ CD38+", "CD4 Tcm CD25+", "CD4 Tnl CD25+")

dfScientistFilter <- dfFresh %>%
  filter(Staining_Flow_Researcher == "A") %>%
  filter(metric %in% ScientistFilter)

#generate df filtering out non-standard HPAP tissues
dfLineageFilter <- anti_join(dfFresh, dfScientistFilter) %>%
  filter(Tissue != "PBMC") %>% #removed since PBMCs have artifacts in the neutrophil counts due to long term blood storage
  filter(Tissue != "Islet_Sup") %>% #removed since it is not a standard HPAP tissue
  filter(Tissue != "Whole_Blood") %>% #removed since it is not a standard HPAP tissue
  mutate(metric = str_replace(metric, " \\(%CD45\\+\\)", "")) %>%
  mutate(metric = str_replace(metric, " \\(%CD45\\)", "")) %>%
  mutate(metric = str_replace(metric, " \\(%T cells\\)", " T cells"))
```


Section 5: Tissue Distribution of Immune Populations
```{r Section 5: Tissue Distribution - Commonly used lineage parameters, total lineage df for ggplot}
LineageList <- c("Eosinophils", "Neutrophils", "B cells","ILCs", "Imm. Granulocytes", "HSCs", "DCs", "Monocytes", "NK cells", "T cells", "CD8+ T cells", "CD8 Tcm", "CD8 Tem", "CD8 Temra", "CD8 Tn", "CD8 Tnl", "CD4+ T cells", "CD4 Tcm", "CD4 Tem", "CD4 Temra", "CD4 Tn", "CD4 Tnl", "CD4 Mem Tregs", "CD4 Mem gcTfh", "CD4 Mem mTfh")
LinColorsOnly <- c("#BC4749", "#228B22", "#73A942", "#023E8A", "#0777B6", "#00B4D8")

#generate df for plotting lineage cell populations
dfTotalLineageFreq <- filter(dfLineageFilter, metric %in% LineageList)
```

```{r Section 5: Tissue Distribution - Heatmap of major immune population frequency across tissues}
LinTissueColorsHeatmap <- list(`Tissue` = c("Spleen" = "#BC4749","SMA mLN" = "#228B22", "MES mLN" = "#73A942", "Head pLN" = "#023E8A", "Body pLN" = "#0777B6", "Tail pLN" = "#00B4D8"))

#generate a df that is compatible with heatmap generation
dfHeatmapNorm <- dfLineageFilter %>%
  group_by(metric) %>%
  mutate(z_score = scale(value)) %>%
  dplyr::select("HPAP Donor":metric,z_score)

#heatmap of major immune cell population distribution across HPAP tissues
LinTissueOrder <- c("Spleen", "Head pLN", "Body pLN", "Tail pLN", "SMA mLN", "MES mLN")
SampleVariablesLin <- c("HPAP Donor", "Tissue")

dfTotalLineageHeatmap <- dfHeatmapNorm %>%
  pivot_wider(names_from = metric, values_from = z_score) %>%
  dplyr::select(SampleVariablesLin, LineageList) %>%
  mutate(Sample_ID = paste("S", as.character(row_number()), sep = "")) %>%
  relocate(Sample_ID, .before = `HPAP Donor`) %>%
  mutate(Tissue = str_replace_all(Tissue,"_", " "))

dfTotalLineageHeatmap <- as.data.frame(dfTotalLineageHeatmap)
rownames(dfTotalLineageHeatmap) <- dfTotalLineageHeatmap$Sample_ID
dfTotalLineageHeatmap <- dplyr::select(dfTotalLineageHeatmap, `HPAP Donor`:ncol(dfTotalLineageHeatmap))

dfLinHeatmapMetadata <- dplyr::select(dfTotalLineageHeatmap, Tissue)

dfTotalLineageHeatmap <- dplyr::select(dfTotalLineageHeatmap, "Eosinophils":ncol(dfTotalLineageHeatmap))
dfTotalLineageHeatmap <- t(dfTotalLineageHeatmap)

col_fun_LineageHM <- colorRamp2(c(-2, 0, 2), c("blue", "white", "red")) #set maxima at 5th and 95th percentiles
LinAnn <- HeatmapAnnotation(df = dfLinHeatmapMetadata,
                  which = "col",
                  col = LinTissueColorsHeatmap,
                  simple_anno_size = unit(0.1, "in"),
                  height = unit(0.1, "in"),
                  annotation_name_gp = gpar(fontsize = 8),
                  annotation_legend_param = list(
                        title = "Tissue",
                        at = LinTissueOrder,
                        labels = LinTissueOrder,
                        legend_height = unit(0.5, "in"),
                        grid_width = unit(0.1, "in"),
                        labels_gp = gpar(fontsize = 4),
                        title_gp = gpar(fontsize = 6)
                  ))

set.seed(42)

LinHeatmap <- Heatmap(dfTotalLineageHeatmap,
                      name = "Z-score",
                      col = col_fun_LineageHM,
                      show_column_names = FALSE,
                      top_annotation = LinAnn,
                      cluster_columns = diana,
                      row_km = 3,
                      row_title_gp = gpar(fontsize = 10),
                      row_title_rot = 0,
                      row_names_gp = gpar(fontsize = 4),
                      row_dend_width = unit(0.1, "in"),
                      column_dend_height = unit(0.2, "in"),
                      heatmap_legend_param = list(
                        legend_height = unit(0.5, "in"),
                        grid_width = unit(0.1, "in"),
                        labels_gp = gpar(fontsize = 4),
                        title_gp = gpar(fontsize = 6)
                      ))
#draw(LinHeatmap, merge_legends = TRUE)
saveRDS(LinHeatmap, file = "./outs/rds/LinHeatmap.RDS")
```

```{r Section 5: Tissue Distribution - Statistics of lineage immune populations across tissues}
#create a statistics-friendly df to test significance differences of lineage immune populations across tissues
dfTotalLineageFreqStats <- dfTotalLineageFreq %>%
  pivot_wider(names_from = metric, values_from = value)
colnames(dfTotalLineageFreqStats) <- gsub("\\+ \\(\\%T ?cells\\)", "", colnames(dfTotalLineageFreqStats))
colnames(dfTotalLineageFreqStats) <- gsub(" ", "_", colnames(dfTotalLineageFreqStats))

#use Dunn's test on every major lineage cell population to look for statistical differences between tissues
colnameTissue <- names(dfTotalLineageFreqStats)[3] #the Tissue column name
LineageListStats <- dfTotalLineageFreqStats[13:ncol(dfTotalLineageFreqStats)] %>%
  colnames()

LineageFreqStats <- lapply(LineageListStats, function(x) {
  rstatix::dunn_test(dfTotalLineageFreqStats, reformulate(colnameTissue, x))
})
dfLineageFreqStats <- bind_rows(LineageFreqStats)
```

```{r Section 5: Tissue Distribution - Plotting B, T, NK cells, ILCs, CD8 Tcm, CD8 Tn across tissues}
#these populations were selected based upon similarity across subsets (B cells), differences between spleen and all LNs (T cells, CD8 Tn), and subtle differences among LNs (NK cells, ILCs, and CD8 Tcm)
LinPops <- c("B cells", "T cells", "NK cells", "ILCs", "CD8 Tcm", "CD8 Tn")

LinPopsGraphs <- lapply(LinPops, function(l) {
  message(paste("Generating graph for", l, "across tissues"), sep = "")
  lplot <- dfTotalLineageFreq %>%
    filter(metric == as.character(l)) %>%
    mutate(Tissue = str_replace(Tissue, "_", " ")) %>%
    mutate(Tissue = fct_relevel(Tissue, "Spleen", "SMA mLN", "MES mLN", "Head pLN", "Body pLN", "Tail pLN")) %>%
    ggplot(aes(Tissue, value, color = Tissue)) +
    geom_boxplot(width = 0.8,
               outlier.shape = NA,
               show.legend = FALSE) +
    geom_point(
    size = 1,
    stroke = 0.2,
    alpha = 0.4,
    show.legend = FALSE,
    position = position_jitterdodge(jitter.width = 1, 
                                    dodge.width = 0.8)) +
    scale_color_manual(values = LinColorsOnly) +
    ylab("% of CD45+ cells") +
    theme_classic() +
    theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(size = 8)
    )
  saveRDS(lplot, file = paste0("./outs/rds/Tissues ", as.character(l),".RDS"))
})
```

```{r Section 5: Tissue Distribution - Generate PCA-compatible dataframe and metadata for entire dataset}
#PCA compatible dataframe for the entire dataset
dfPCA <- dfLineageFilter %>%
  dplyr::select(1:Tissue, metric:ncol(dfLineage)) %>%
  pivot_wider(id_cols = `HPAP Donor`:`Tissue`, names_from = metric, values_from = value) %>%
  mutate(Sample_ID = paste("S", as.character(row_number()), sep = "")) %>%
  relocate(Sample_ID, .before = `HPAP Donor`) %>%
  as.data.frame()
rownames(dfPCA) <- dfPCA$Sample_ID
```

```{r Section 5: Tissue Distribution - Generate PCA plots/biplots to examine tissue immune lineage differences}
#PCA for immune lineage
dfLineagePCA <- dplyr::select(dfPCA, LineageList)
TotalLinPCA <- prcomp(dfLineagePCA, scale. = TRUE)

dfTotalLinPCA <- TotalLinPCA$x %>%
  as.data.frame() %>%
  mutate(Sample_ID = rownames(dfLineagePCA)) %>%
  full_join(dfPCA, by = "Sample_ID")

Lin_var_explained <- TotalLinPCA$sdev^2/sum(TotalLinPCA$sdev^2)

TotalLinPCAplot <- dfTotalLinPCA %>%
  mutate(Tissue = str_replace(Tissue, "_", " ")) %>%
  mutate(Tissue = fct_relevel(Tissue, "Spleen", "SMA mLN", "MES mLN", "Head pLN", "Body pLN", "Tail pLN")) %>%
  ggplot(aes(PC1, PC2, color = Tissue)) +
  geom_point(size = 0.5) +
  #geom_text(label = dfTotalLinPCA$`HPAP Donor`, nudge_y = TRUE) +
  labs(x=paste0("PC1: ",round(Lin_var_explained[1]*100,1),"%"),
       y=paste0("PC2: ",round(Lin_var_explained[2]*100,1),"%")) +
  scale_color_manual(values = LinColorsOnly) +
  theme_classic()

TotalLinPCAplot
saveRDS(TotalLinPCAplot, file = "./outs/rds/LinPCA.RDS")

dfTotalLinBiplot <- TotalLinPCA$rotation %>%
  as.data.frame() %>%
  mutate(Population = rownames(TotalLinPCA$rotation))

TotalLinBiPlot <- dfTotalLinBiplot %>%
  ggplot(aes(PC1, PC2)) +
  geom_segment(aes(x = 0, y = 0, xend = dfTotalLinBiplot$PC1, yend = dfTotalLinBiplot$PC2), 
               arrow = arrow(angle = 20, 
                             length = unit(0.02, "inches"),
                             ends = "last",
                             type = "closed"),
               color = "grey",
               linewidth = 0.2) +
  geom_text_repel(label = dfTotalLinBiplot$Population, 
                  size = 1, 
                  min.segment.length = 0.2,
                  segment.color = "darkblue",
                  segment.alpha = 0.5,
                  segment.size = 0.2,
                  seed = 42) +
  theme_classic()
TotalLinBiPlot
saveRDS(TotalLinBiPlot, file = "./outs/rds/LinPCAbiplot.RDS")
```

```{r Section 5: Tissue Distribution - Generate PCA plots to visualize tissue CD4+ T cell, CD8+ T cell, and B cell differences}
#Because there were significant differences between researchers, some populations from certain samples were omitted from the dataset. 
#These produce NA values, and therefore the prcomp function must use a dataframe that either omits the rows 
#using the CD4 Tcm CD25 population for this filter, since it is one of the qualifying populations

dfPCAfilter <- dfPCA %>%
  filter(!is.na(`CD4 Tcm CD25+`)) 

#PCA for CD4 populations
pcaCD4Pops <- c()
pcaCD4Pops <- append(pcaCD4Pops, str_match(colnames(dfPCA), "^CD4 .*$"))
pcaCD4Pops <- pcaCD4Pops[!is.na(pcaCD4Pops)]
pcaCD4Pops <- pcaCD4Pops %>%
  str_remove("CD4 Tn CD127.CD27.") %>%
  str_remove("CD4 Tn CD27.") %>%
  str_remove("CD4 Tn CD127.") %>%
  str_remove("CD4 Tnl CD127\\+CD27\\+") %>%
  str_remove("^CD4 Mem .*$")
pcaCD4Pops <- pcaCD4Pops[pcaCD4Pops != ""]

dfCD4forPCA <- dplyr::select(dfPCAfilter, all_of(pcaCD4Pops))
  
CD4PCA <- prcomp(dfCD4forPCA, scale. = TRUE)

dfCD4PCA <- CD4PCA$x %>%
  as.data.frame() %>%
  mutate(Sample_ID = rownames(dfCD4forPCA)) %>%
  full_join(dfPCAMetadata, by = "Sample_ID")

CD4_var_explained <- CD4PCA$sdev^2/sum(CD4PCA$sdev^2)

CD4PCAplot <- dfCD4PCA%>%
  mutate(Tissue = str_replace(Tissue, "_", " ")) %>%
  mutate(Tissue = fct_relevel(Tissue, "Spleen", "SMA mLN", "MES mLN", "Head pLN", "Body pLN", "Tail pLN")) %>%
  ggplot(aes(PC1, PC2, color = Tissue)) +
  geom_point(size = 0.5) +
  labs(x=paste0("PC1: ",round(CD4_var_explained[1]*100,1),"%"),
       y=paste0("PC2: ",round(CD4_var_explained[2]*100,1),"%")) +
  scale_color_manual(values = LinColorsOnly) +
  theme_classic()

#CD4PCAplot
saveRDS(CD4PCAplot, file = "./outs/rds/CD4PCA.RDS")

#PCA for CD8 populations
pcaCD8Pops <- c()
pcaCD8Pops <- append(pcaCD8Pops, str_match(colnames(dfPCA), "^CD8 .*$"))
pcaCD8Pops <- pcaCD8Pops[!is.na(pcaCD8Pops)]
pcaCD8Pops <- pcaCD8Pops %>%
  str_remove("CD8 Tn CD127.CD27.") %>%
  str_remove("CD8 Tn CD27.") %>%
  str_remove("CD8 Tn CD127.") %>%
  str_remove("CD8 Tnl CD127\\+CD27\\+") %>%
  str_remove("^CD8 Mem .*$")
pcaCD8Pops <- pcaCD8Pops[pcaCD8Pops != ""]

dfCD8forPCA <- dplyr::select(dfPCAfilter, all_of(pcaCD8Pops))
  
CD8PCA <- prcomp(dfCD8forPCA, scale. = TRUE)

dfCD8PCA <- CD8PCA$x %>%
  as.data.frame() %>%
  mutate(Sample_ID = rownames(dfCD8forPCA)) %>%
  full_join(dfPCAMetadata, by = "Sample_ID")

CD8_var_explained <- CD8PCA$sdev^2/sum(CD8PCA$sdev^2)

CD8PCAplot <- dfCD8PCA%>%
  mutate(Tissue = str_replace(Tissue, "_", " ")) %>%
  mutate(Tissue = fct_relevel(Tissue, "Spleen", "SMA mLN", "MES mLN", "Head pLN", "Body pLN", "Tail pLN")) %>%
  ggplot(aes(PC1, PC2, color = Tissue)) +
  geom_point(size = 0.5) +
  labs(x=paste0("PC1: ",round(CD8_var_explained[1]*100,1),"%"),
       y=paste0("PC2: ",round(CD8_var_explained[2]*100,1),"%")) +
  scale_color_manual(values = LinColorsOnly) +
  theme_classic()

#CD8PCAplot
saveRDS(CD8PCAplot, file = "./outs/rds/CD8PCA.RDS")

#PCA for B cell populations
pcaBPops <- c()
pcaBPops <- append(pcaBPops, str_match(colnames(dfPCA), "^B cells .*$"))
pcaBPops <- pcaBPops[!is.na(pcaBPops)]

dfBforPCA <- dplyr::select(dfPCAfilter, all_of(pcaBPops))
  
BPCA <- prcomp(dfBforPCA, scale. = TRUE)

dfBPCA <- BPCA$x %>%
  as.data.frame() %>%
  mutate(Sample_ID = rownames(dfBforPCA)) %>%
  full_join(dfPCAMetadata, by = "Sample_ID")

B_var_explained <- BPCA$sdev^2/sum(BPCA$sdev^2)

BPCAplot <- dfBPCA%>%
  mutate(Tissue = str_replace(Tissue, "_", " ")) %>%
  mutate(Tissue = fct_relevel(Tissue, "Spleen", "SMA mLN", "MES mLN", "Head pLN", "Body pLN", "Tail pLN")) %>%
  ggplot(aes(PC1, PC2, color = Tissue)) +
  geom_point(size = 0.5) +
  labs(x=paste0("PC1: ",round(B_var_explained[1]*100,1),"%"),
       y=paste0("PC2: ",round(B_var_explained[2]*100,1),"%")) +
  scale_color_manual(values = LinColorsOnly) +
  theme_classic()

#BPCAplot
saveRDS(BPCAplot, file = "./outs/rds/BPCA.RDS")
```


Section 6: Immune Population Frequencies Across Disease State
```{r Section 6: Disease State - Checking metadata differences across disease state}
MetaFactors <- c("HPAP Donor", "Disease Status", "Tissue", "cold_ischemia", "Sex", "Age", "Staining_Flow_Researcher")

dfMetaCheck <- dfLineageFilter %>%
  dplyr::select(all_of(MetaFactors)) %>%
  filter(Tissue != "Spleen") %>%
  distinct()

#GGally::ggpairs(dfMetaCheck, cardinality_threshold = 46)

coldIsDisease <- dfMetaCheck %>%
  mutate(`Disease Status` = fct_relevel(`Disease Status`, "ND", "AAb+", "T1D")) %>%
  ggplot(aes(`Disease Status`, cold_ischemia)) +
  geom_boxplot() +
  ylab("Cold Ischemia Time (hr)") +
  theme_classic() +
  theme(axis.title.x = element_blank())

coldIsDisease

#the above graphs show that cold ischemia time is significantly lower in normal donors compared to AAb+ and T1D donors. This will have to be accounted for in further analyses.
#generating plots to check if cold ischemia influences the rate of any immune populations

#generate a stats-friendly dataframe for all immune populations
dfAllPopsFreqStats <- dfLineageFilter %>%
  pivot_wider(names_from = metric, values_from = value)
colnames(dfAllPopsFreqStats) <- gsub("\\+ \\(\\%T ?cells\\)", "", colnames(dfAllPopsFreqStats))
colnames(dfAllPopsFreqStats) <- gsub(" ", "_", colnames(dfAllPopsFreqStats))

#robust ANOVA of cold ischemia time across the 3 disease states shows trending significantly lower cold ischemia in ND
lincon(cold_ischemia ~ Disease_Status, data = distinct(dfAllPopsFreqStats, HPAP_Donor, Disease_Status, cold_ischemia), tr = 0.1)

#inputs and function that generates correlation p values for cold ischemia v all immune populations
coldIsFreqStats <- filter(dfAllPopsFreqStats, !is.na(cold_ischemia)) %>%
  filter(Disease_Status == "ND") %>%
  filter(Tissue != "Spleen")
coldIsPops <- colnames(coldIsFreqStats[15:ncol(coldIsFreqStats)])

dfcoldIsCorrStats <- lapply(coldIsPops, function(x) {
  corrx <- cor_test(coldIsFreqStats, x, cold_ischemia, method = "spearman")
}) %>%
  bind_rows()

#for visualizing plots of interest (correlation value >= 0.3 or <= -0.3)
dfcoldIsPops2 <- dfcoldIsCorrStats %>%
  filter(cor >= 0.3 | cor <= -0.3) %>%
  arrange(desc(cor))
coldIsPops2 <- dfcoldIsPops2$var1

#create a dataframe for labeling points in correlation ranked plot below:
dfcoldIsPopsLebel <- dfcoldIsPops2 %>%
  filter(!str_detect(var1, "CD._T.*_CD127.CD27.")) %>%
  filter(!str_detect(var1, "CD._Tn_CD27.")) %>%
  filter(!str_detect(var1, "CD._Tn_CD127.")) %>%
  filter(!str_detect(var1, "CD._T.*_CD127\\+CD27\\+")) %>%
  filter(!str_detect(var1, "^CD._Mem_CD.*$")) %>%
  filter(!str_detect(var1, "^CD._Mem_.*\\+$")) %>%
  filter(cor >= 0.3 | cor <= -0.3)


#ranked correlation plot of cold ischemia effects on immune population frequency
coldIsRankedPlot <- dfcoldIsCorrStats %>%
  filter(!is.na(cor)) %>%
  filter(!str_detect(var1, "CD._T.*_CD127.CD27.")) %>%
  filter(!str_detect(var1, "CD._Tn_CD27.")) %>%
  filter(!str_detect(var1, "CD._Tn_CD127.")) %>%
  filter(!str_detect(var1, "CD._T.*_CD127\\+CD27\\+")) %>%
  filter(!str_detect(var1, "^CD._Mem_CD.*$")) %>%
  filter(!str_detect(var1, "^CD._Mem_.*\\+$")) %>%
  ggplot(aes(reorder(var1, -cor), cor)) +
  geom_hline(yintercept = c(0.3, -0.3),
             linetype = "dashed",
             color = "grey") +
  geom_point(size = 0.3) + 
  geom_point(data = dfcoldIsPopsLebel, aes(var1, cor), color = "blue", size = 0.3) +
  geom_text_repel(data = filter(dfcoldIsPopsLebel), 
                  aes(var1, cor, label = var1), size = 0.8, seed = 42, 
                  segment.size = 0.1, segment.alpha = 0.3, max.overlaps = 50) +
  ylab("Spearmann Corr. Value") +
  xlab("Immune Population") +
  theme_classic() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 6),
    axis.ticks.length.x = unit(0, "in"),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8)
  )

#coldIsRankedPlot

#what can be concluded is that although the correlation lines fit the data poorly, due to high variance in immune values in the dataset, some immune populations do significantly change with an increase in cold ischemia time. 
#Cold ischemia must be considered in any statistical tests comparing immune populations across disease status if cold ischemia has a significant effect. Please see below for what is determined as "significant".
```

```{r Section 6: Disease State - Immune population statistical differences across disease state: separate tissues}
# the above section shows that cold ischemia time has an impact across disease state on certain immune populations.
# To control for this, ANCOVA will be used to account for cold ischemia time.
# Populations affected by cold ischemia are defined as having a significant p value and an R value >= 0.3 or <= -0.3.
# These thresholds are used because using ANCOVA when a factor has a small affect can be detrimental, as over-correcting can lead to errant results.
# for immune populations that are not significantly affected by cold ischemia, robust ANOVA will be used.
# Robust ANOVA trims 10% of the values in the extremes, thus being less sensitive to outliers and differences in variance than standard ANOVA.

#ANOVA cannot be computed when values have zero variance, hence CD27/CD127 in Tn must be removed
TissueSepAnovapops <- dfAllPopsFreqStats %>%
  dplyr::select(15:ncol(dfAllPopsFreqStats)) %>%
  colnames() %>%
  str_remove("CD._Tn_CD127.CD27.") %>%
  str_remove("CD._Tn_CD27.") %>%
  str_remove("CD._Tn_CD127.") %>%
  str_remove("CD._Tnl_CD127\\+CD27\\+") %>%
  str_remove("^CD._Mem_CD.*$") %>%
  str_remove("^CD._Mem_.*\\+$")
TissueSepAnovapops <- TissueSepAnovapops[TissueSepAnovapops != ""]

dfAllPopsFreqStatsANOVA <- dfAllPopsFreqStats %>%
  pivot_longer(cols = 15:ncol(dfAllPopsFreqStats),
               names_to = "metric",
               values_to = "value")
alltissues <- unique(dfAllPopsFreqStats$Tissue)

#tissues pooled by general anatomical location (pLN/mesLN/spleen) 
LN_types <- unique(dfAllPopsFreqStatsANOVA$LN_type)

dfDiseasePoolStats <- lntypeColisANOVA(anovapops = TissueSepAnovapops, 
                                        lntype = LN_types,
                                        df = dfAllPopsFreqStatsANOVA,
                                        selectpops = coldIsPops2)

#tissues separated; run robust ANOVA with 10% trim / ANCOVA controlling for cold ischemia
dfDiseaseTissuesSepStats <- tissueColisANOVA(anovapops = TissueSepAnovapops, 
                                              tissues = alltissues,
                                              df = dfAllPopsFreqStatsANOVA,
                                              selectpops = coldIsPops2)
```

```{r Section 6: Disease State - Generate heatmap showing significantly changing populations across disease states}
LNcolor <- c("pLN" = "#0777B6", "mLN" = "#73A942", "Spleen" = "#BC4749")
LNorder <- c("pLN", "mLN", "Spleen")
pvalColor <- c("ns" = "#dadaeb", "*" = "#b3cde3", "**" = "#8c96c6", "***" = "#88419d")
pvalOrder <- c("ns", "*", "**", "***")

dfNormTissuePop <- dfLineageFilter %>%
  group_by(metric, LN_type) %>%
  mutate(z_score = scale(value)) %>%
  dplyr::select("HPAP Donor":metric,z_score)
  
dfsigPopsDisease <- dfDiseasePoolStats %>%
  mutate(immune_pop = str_replace_all(immune_pop, "_", " ")) %>%
  mutate(pvalNDT1D = case_when(ND_T1D < 0.001 ~ "***",
                          ND_T1D >= 0.001 & ND_T1D < 0.01 ~ "**",
                          ND_T1D >= 0.01 & ND_T1D < 0.05 ~ "*")) %>%
  mutate(pvalNDAAb = case_when(ND_AAb < 0.001 ~ "***",
                          ND_AAb >= 0.001 & ND_AAb < 0.01 ~ "**",
                          ND_AAb >= 0.01 & ND_AAb < 0.05 ~ "*")) %>%
  mutate(pvalAAbT1D = case_when(AAb_T1D < 0.001 ~ "***",
                          AAb_T1D >= 0.001 & AAb_T1D < 0.01 ~ "**",
                          AAb_T1D >= 0.01 & AAb_T1D < 0.05 ~ "*")) %>%
  filter(!is.na(pvalNDT1D) | !is.na(pvalNDAAb) | !is.na(pvalAAbT1D)) %>%
  replace_na(list(pvalNDT1D = "ns", pvalNDAAb = "ns", pvalAAbT1D = "ns"))

dfsigPopsSamples <- dfsigPopsDisease %>%
  dplyr::select(immune_pop, tissue) %>%
  filter(!grepl("CD127.CD27.", immune_pop)) %>% #for large heatmap, CD27 and CD127 will be separated for viewing ease
  filter(!grepl("Tregs$", immune_pop)) #for large heatmap, Tregs represented by CD4+ Tem CD25+ (mostly)

dfsigPopsHeatmap <- dfNormTissuePop %>%
  group_by(metric, `Disease Status`, LN_type) %>%
  summarise(zMean = mean(z_score)) %>%
  pivot_wider(names_from = `Disease Status`, values_from = zMean) %>% 
  rename("immune_pop" = "metric") %>%
  rename("tissue" = "LN_type") %>%
  right_join(dfsigPopsSamples) %>%
  ungroup() %>%
  mutate(Sample_ID = paste("S", as.character(row_number()), sep = "")) %>%
  relocate(Sample_ID, .before = immune_pop) %>%
  left_join(dfsigPopsDisease) %>%
  relocate(pvalNDT1D:pvalAAbT1D, .before = ND_T1D) %>%
  as.data.frame()

rownames(dfsigPopsHeatmap) <- dfsigPopsHeatmap$Sample_ID
dfsigPopsHeatmap <- dplyr::select(dfsigPopsHeatmap, immune_pop:ncol(dfsigPopsHeatmap))
immune_pops_names <- structure(dfsigPopsHeatmap$immune_pop, names = rownames(dfsigPopsHeatmap))

dfsigPopsHeatmapPlot <- dfsigPopsHeatmap %>%
  dplyr::select(`AAb+`:T1D) %>%
  as.matrix()

col_fun_DiseaseHm <- colorRamp2(c(-0.75, 0, 0.75), c("blue", "white", "red")) 
DiseaseAnn <- HeatmapAnnotation(`LNs` = dfsigPopsHeatmap$tissue,
                              `NDAAb` = dfsigPopsHeatmap$pvalNDAAb,
                              `AAbT1D` = dfsigPopsHeatmap$pvalAAbT1D,
                              `NDT1D` = dfsigPopsHeatmap$pvalNDT1D,
                              which = "row",
                              col = list(`LNs` = LNcolor, `NDT1D` = pvalColor, 
                                         `NDAAb` = pvalColor, `AAbT1D` = pvalColor),
                              simple_anno_size = unit(0.1, "in"),
                              show_annotation_name = TRUE,
                              annotation_label = c(`LNs` = "Tissue", `NDAAb` = "ND v AAb+", 
                                                   `AAbT1D` = "AAb+ v T1D", `NDT1D` = "ND v T1D"),
                              annotation_name_side = "top",
                              annotation_name_rot = 45,
                              annotation_name_offset = unit(0.05, "in"),
                              annotation_name_gp = gpar(fontsize = 6),
                              gap = unit(c(0.1, 0, 0), "in"),
                              show_legend = c(`LNs` = TRUE, `NDAAb` = TRUE,
                                              `AAbT1D` = FALSE, `NDT1D` = FALSE),
                              annotation_legend_param = list(
                                `LNs` = list(title = "Tissue",
                                  at = LNorder,
                                  labels = LNorder,
                                  title_position = "topcenter",
                                  grid_width = unit(0.1, "in"),
                                  grid_height = unit(0.1, "in"),
                                  labels_gp = gpar(fontsize = 4),
                                  title_gp = gpar(fontsize = 6)),
                                `NDAAb` = list(title = "P-value",
                                  at = pvalOrder,
                                  labels = pvalOrder,
                                  ncol = 2,
                                  title_position = "topcenter",
                                  grid_width = unit(0.1, "in"),
                                  grid_height = unit(0.1, "in"),
                                  labels_gp = gpar(fontsize = 4),
                                  title_gp = gpar(fontsize = 6)) 
                              ))
                          
set.seed(42)

DiseaseHeatmap <- Heatmap(dfsigPopsHeatmapPlot,
                      name = "Mean Z-score",
                      col = col_fun_DiseaseHm,
                      column_order = c("ND", "AAb+", "T1D"),
                      show_column_names = TRUE,
                      column_names_side = "top",
                      column_names_rot = 0,
                      column_names_centered = TRUE,
                      column_names_gp = gpar(fontsize = 7, fontface = "bold"),
                      row_km = 3,
                      row_gap = unit(0.1, "in"),
                      right_annotation = DiseaseAnn,
                      row_title_gp = gpar(fontsize = 10),
                      row_title_rot = 0,
                      row_labels = immune_pops_names,
                      row_names_gp = gpar(fontsize = 5),
                      row_dend_width = unit(0.3, "in"),
                      heatmap_legend_param = list(
                        legend_direction = "horizontal",
                        legend_width = unit(0.6, "in"),
                        title_position = "topcenter",
                        grid_height = unit(0.1, "in"),
                        labels_gp = gpar(fontsize = 4),
                        title_gp = gpar(fontsize = 6)
                      ))
#draw(DiseaseHeatmap, merge_legends = TRUE, heatmap_legend_side = "bottom")
saveRDS(DiseaseHeatmap, file = "./outs/rds/DiseaseHeatmap.RDS")
```

```{r Section 6: Disease State - CD25+ and CD38+ frequency across all T cell subsets}
#the previous section demonstrated that CD25 changed across disease state in many T cell subsets.
#this will be explored further within this section
diseaseColors <- c("ND" = "#949494", "AAb+" = "#2E96FF", "T1D" = "#FF8B3D")

dfDiseaseScales <- dfLineageFilter %>%
  group_by(metric, LN_type) %>%
  mutate(z_score = scale(value)) %>%
  ungroup() %>%
  filter(!grepl("^CD. Mem CD.*$", metric)) %>%
  filter(!grepl("^CD. Mem .*\\+$", metric)) %>%
  filter(grepl("CD. ", metric)) %>%
  mutate(`Disease Status` = fct_relevel(`Disease Status`, "ND", "AAb+", "T1D")) %>%
  mutate(LN_type = as_factor(LN_type)) %>%
  mutate(`LN_type` = fct_relevel(`LN_type`, "pLN", "mLN", "Spleen")) %>%
  mutate(cd = case_when(str_detect(metric, "CD4") ~ "CD4",
                        str_detect(metric, "CD8") ~ "CD8")) %>%
  mutate(tpop = case_when(str_detect(metric, "Tn ") ~ "Tn",
                        str_detect(metric, "Tnl") ~ "Tnl",
                        str_detect(metric, "Tcm") ~ "Tcm",
                        str_detect(metric, "Tem ") ~ "Tem",
                        str_detect(metric, "Temra") ~ "Temra",
                        str_detect(metric, "Tn$") ~ "Tn",
                        str_detect(metric, "Tem$") ~ "Tem",
                        str_detect(metric, "CD4 Mem") ~ "Mem")) %>%
  mutate(tpop = as_factor(tpop)) %>%
  mutate(tpop = fct_relevel(tpop, "Tn", "Tnl", "Tcm", "Tem", "Temra"))

CD25_CD38_boxplot_list <- list("CD25+_CD4_CD4+ T cells" , "CD25+_CD8_CD8+ T cells", "CD38+_CD4_CD4+ T cells", "CD38+_CD8_CD8+ T cells") #string will be split at _ for graph creation

CD25_CD38_facetLabels <- c("Tn", "Tnl", "Tcm", "Tem", "Temra")

CD25_CD38_boxplot_graphs <- lapply(CD25_CD38_boxplot_list, function(c) {
  strings <- unlist(strsplit(c, "_"))
  message(paste("Generating a graph for", strings[1], strings[3]))
  graph <- dfDiseaseScales %>%
    filter(grepl(strings[1], metric)) %>%
    filter(!grepl("HLA-DR+", metric)) %>%
    filter(LN_type != "Spleen") %>%
    filter(cd == strings[2]) %>%
    ggplot(aes(`Disease Status`, value, color = `Disease Status`)) +
      ylab(paste("%", strings[1], "of", strings[3])) +
      geom_boxplot(width = 0.8,
               outlier.shape = NA,
               show.legend = FALSE) +
       geom_point(
          size = 1,
          stroke = 0.2,
          alpha = 0.4,
          show.legend = FALSE,
          position = position_jitterdodge(jitter.width = 1, dodge.width = 0.8)) +
       scale_color_manual(values = diseaseColors) +
       theme_classic() +
       theme(axis.title.x = element_blank(),
         axis.text.x = element_text(angle = 45, hjust = 1),
         axis.title.y = element_text(size = 8)) +
      facet_grid(cols = vars(tpop), switch = "y")
  saveRDS(graph, file = paste0("./outs/rds/",strings[1], " ", strings[3], " boxplots.RDS"))
  })
```

```{r Section 6: Disease State - Box Plots for significantly changing populations}
#the heatmap above showed significant changes across disease state for these populations: CD25+ T cells, CD4 Tn cells, NK cell cytotoxicity, and CD27+ B cells. 
#reductions in CD25+ frequency in AAb+ pLN in several T cell subsets implies Tregs may also be affected, so Tregs will be plotted across disease state (CD25 was plotted above).

Disease_BoxPlots_pops <- list("pLN_B cells CD27+_B cells", "pLN_CD4 Mem Tregs_Mem CD4+ T cells", "pLN_NK CD56dimCD16+_NK cells", "pLN_CD4 Tn_CD4+ T cells", "mLN_CD4 Tn_CD4+ T cells") #underscore denotes where string split will occur

Disease_BoxPlots_graphs <- lapply(Disease_BoxPlots_pops, function(d) {
  message("Generating a graph for ", d)
  strings <- unlist(strsplit(d, "_"))
  graph <- dfLineageFilter %>%
    filter(LN_type == strings[1]) %>%
    filter(metric == strings[2]) %>%
    mutate(`Disease Status` = fct_relevel(`Disease Status`, "ND", "AAb+", "T1D")) %>%
    ggplot(aes(`Disease Status`, value, color = `Disease Status`)) +
    geom_boxplot(width = 0.8,
               outlier.shape = NA,
               show.legend = FALSE) +
    geom_point(
      size = 1,
      stroke = 0.2,
      alpha = 0.4,
      show.legend = FALSE,
      position = position_jitterdodge(jitter.width = 1, 
                                      dodge.width = 0.8)) +
    ggtitle(strings[2]) +
    ylab(paste("% of", strings[3])) +
    scale_color_manual(values = diseaseColors) +
    theme_classic() +
    theme(
    plot.title = element_text(size = 10),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(size = 8)
    )
  saveRDS(graph, file = paste0("./outs/rds/",strings[2], " ", strings[1], " boxplots.RDS"))
})
```

```{r Section 6: Disease State - CD27+ and CD127+ across disease in statistically significant populations}
#the heatmap in the section above showed that CD27 and CD127 was significantly modulated across disease state in CD4+ Tem, CD4+ Temra, and CD8+ Tnl cells. 
#Therefore, CD27/CD127 will be plotted in these populations.

df_CD27_CD127_Disease <- dfDiseaseScales %>%
  filter(LN_type == "pLN") %>%
  filter(grepl(" CD27\\+$|CD127\\+$", metric)) %>%
  filter(tpop != "Tn") %>%
  dplyr::select(!z_score) %>%
  mutate(metric = str_remove_all(metric, "CD. \\w{3,5} ")) 

CD27_CD127_tpop_list <- list("CD4 Tem", "CD4 Temra", "CD8 Tnl")

CD27_CD127_graphs <- list()
CD27_CD127_graphs <- lapply(CD27_CD127_tpop_list, function(t) {
  message("Generating CD27/CD127 graphs for ", t)
  cdlist <- unlist(strsplit(t, " "))
  CD27_CD127_graph <- df_CD27_CD127_Disease %>%
    filter(cd == as.character(cdlist[1])) %>%
    filter(tpop == as.character(cdlist[2])) %>%
    ggplot(aes(value, `Disease Status`, color = `Disease Status`, fill = `Disease Status`)) +
    geom_density_ridges(quantile_lines = TRUE, quantiles = c(0.25, 0.5, 0.75), alpha = 0.7) +
    ggtitle(t) +
    xlab(paste0(c("% of", cdlist[1], cdlist[2]), collapse = " ")) +
    theme_classic() +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 10)
    ) +
    xlim(0, 100) +
    scale_color_manual(values = diseaseColors) +
    scale_fill_manual(values = diseaseColors) +
    facet_wrap(vars(metric), nrow = 2) +
    theme(strip.text.x = element_blank())
  saveRDS(CD27_CD127_graph, file = paste0("./outs/rds/", cdlist[1], " ", cdlist[2], " CD27-CD127", " ridgelines.RDS"))
})
```